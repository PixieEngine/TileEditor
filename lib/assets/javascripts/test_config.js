window.testConfig = {"data":{"width":20,"height":15,"tileWidth":32,"tileHeight":32,"title":"","entityCache":{"absorb_enemy":{"name":"Unnamed Entity","width":32,"height":32,"class":"AbsorbEnemy","parentClass":"Enemy","__CODE":"I.directions = []\n\nI.sprite = 'jelly0'\n\njelly0 = Sprite.loadByName 'jelly0'\njelly1 = Sprite.loadByName 'jelly1'\njelly2 = Sprite.loadByName 'jelly2'\n\nI.sprites = [jelly1, jelly0, jelly2, jelly0]\n\nself.every 0.2, ->\n  I.spriteIndex = (I.spriteIndex + 1) % I.sprites.length\n\nself.on 'update', ->  \n  I.sprite = I.sprites[I.spriteIndex]\n  ","uuid":"absorb_enemy","spriteIndex":0},"boomerang_enemy":{"name":"Unnamed Entity","width":32,"height":32,"class":"BoomerangEnemy","parentClass":"Enemy","__CODE":"I.directions = [Point(20, -10)]","uuid":"boomerang_enemy","sprite":"boomerang_enemy","boomerang":true,"lineColor":"orange"},"bullet":{"name":"Unnamed Entity","width":12,"height":12,"class":"Bullet","parentClass":"GameObject","speed":240,"stuckTo":null,"zIndex":50,"__CODE":"I.directions = []\n\nI.color = 'transparent'\n\nmine0 = Sprite.loadByName 'mine0'\nmine1 = Sprite.loadByName 'mine1'\nmine2 = Sprite.loadByName 'mine2'\nmine3 = Sprite.loadByName 'mine3'\nmine4 = Sprite.loadByName 'mine4'\n\nI.particleIndex = 0\n\nI.rotationalVelocities = [\n  Math.TAU / 32\n  Math.TAU / 48\n  Math.TAU / 64\n]\n\nI.rotationalVelocity = I.rotationalVelocities.rand()\n\nI.sprites = [mine0, mine1, mine2, mine3, mine4, mine3, mine2, mine1]\n\nself.every 0.075, ->\n  I.spriteIndex = (I.spriteIndex + 1) % I.sprites.length\n  \nself.extend\n  collisions: (dt) ->\n    Collision.collide self, '.collectable', (bullet, item) ->\n      item.destroy()    \n    \n    Collision.collide self, '.enemy', (bullet, enemy) ->\n      return if enemy.I.class is 'ReflectEnemy'\n      return if enemy.I.class is 'PortalEnemy'\n      \n      if not I.stuckTo and enemy.I.alpha is 1\n        if enemy.I.class is 'ReflectEnemy'          \n          enemy.I.destroyedBy = self\n          \n          enemyRect = Rectangle(enemy.bounds())\n          \n          if bullet.I.x < enemyRect.left or bullet.I.x > enemyRect.right\n            direction = bullet.I.velocity\n            direction.x = -direction.x\n          else if bullet.I.y < enemyRect.top or bullet.I.y > enemyRect.bottom\n            direction = bullet.I.velocity\n            direction.y = -direction.y\n            \n          bullet.I.combo += 1\n        else\n          I.stuckTo = enemy\n          enemy.I.stuckTo = self\n          I.velocity.x = 0\n          I.velocity.y = 0\n  explode: ->    \n    if I.stuckTo\n      if I.stuckTo.I.class is 'PurpleEnemy'\n        I.stuckTo.I.alpha = 0.2\n        I.stuckTo.I.destroyedBy = self\n      else\n        I.stuckTo.I.destroyedBy = self\n        I.stuckTo.destroy()\n        \n    self.destroy()\n  moveTo: (x, y) ->\n    I.x = x\n    I.y = y\n  reflectCollisions: (dt) ->\n    position = self.position()\n    \n    vLine = Line\n      start: position\n      end: position.add(I.velocity.scale(dt))\n  \n    engine.each \"ReflectEnemy\", (enemy) -> \n      return if enemy.I.alpha < 1\n    \n      hit = false\n  \n      enemy.boundingLines().each (line) ->  \n        if line.intersects(vLine)\n          normal = line.normal()\n          push = normal.scale(-2 * I.velocity.dot(normal))\n          \n          I.velocity = I.velocity.add(push)\n          \n          I.x += I.velocity.x * dt\n          I.y += I.velocity.y * dt\n          \n          hit = true \n          \n      if hit\n        enemy.I.destroyedBy = self\n        enemy.tween 0.075, \n          scaleX: 1.2\n          scaleY: 0.8\n          easing: \"quadratic\"\n          complete: ->\n            enemy.tween 0.075, \n              scaleX: 0.8\n              scaleY: 1.2\n              easing: \"quadratic\"\n              complete: ->\n                enemy.tween 0.075, \n                  scaleX: 1.2\n                  scaleY: 0.8\n                  easing: \"quadratic\"\n                  complete: ->\n                    enemy.destroy()  \n               \nself.on 'update', (dt) ->\n  if I.velocity.magnitude() > 0\n    I.particleIndex += 1\n    \n    if I.particleIndex % 5 is 0  \n      engine.add\n        duration: 1\n        fadeOut: true\n        x: I.x\n        y: I.y\n        radius: [1, 2, 2].rand()\n        velocity: Point.fromAngle(I.rotation).scale([50, 10].rand())\n        color: Color('red', 0.6)\n  else  \n    I.rotation = 0\n    \n  I.rotation += I.rotationalVelocity\n  \n  I.sprite = I.sprites[I.spriteIndex]  \n  \n  if I.boomerang\n    I.velocity.x = I.velocity.x.approach(-I.speed * 2, 6)\n    I.velocity.y = I.velocity.y.approach(0, 0.5)\n   \n  self.reflectCollisions(dt)\n  self.collisions(dt)\n      \n  if I.stuckTo\n    {x, y} = I.stuckTo.I\n    \n    self.moveTo(x, y)\n    \n  self.destroy() unless -I.activeBuffer <= I.x <= I.activeBuffer + App.width\n  self.destroy() unless -I.activeBuffer <= I.y <= I.activeBuffer + App.height\n","uuid":"bullet","combo":0,"scaleX":1,"scaleY":1,"tweeningToZero":false,"radius":6,"activeBuffer":80,"spriteIndex":0},"coin":{"name":"Unnamed Entity","width":32,"height":32,"class":"Coin","parentClass":"GameObject","__CODE":"I.sprite = Sprite.loadByName 'coin'\nI.collectable = true\n\nself.on 'destroy', ->\n  if player = engine.first('Player')\n    player.I.coins += 1","uuid":"coin"},"GreenEnemy":{"name":"Unnamed Entity","width":32,"height":32,"class":"GreenEnemy","uuid":"GreenEnemy","__CODE":"I.directions = [\n  Point(-20, 0)\n  Point(20, 0)\n]  ","parentClass":"Enemy","speed":0.25,"oscillate":true,"sprite":"horizontal"},"manager":{"name":"Unnamed Entity","width":32,"height":32,"sprite":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAEzElEQVRYCbWXXYhVVRTH153EbKaZ0RjKRKdrM9NDfqCNFGbJpA8NmBQoJhOEbxH6ECR4lR7DxvLBh8KHXiwoNSiycWAqtIlKERqD0AL7oKYwqalp5tZUEp7Ob5/577vPmXMu89KCe/bea62z/v+91v44txRFkd3x6u+RxbK0pcHefaSlRP//lAffnnR4YMwRUGXNDdY2r2Qy5hE5UDrgX9R7Ybsn2lOXvGLvXDnPvbb74ylroHfp8fml/k//srG/I8PIT84CALy9p90Ni9p6BImn2OAADq7PAJGvTF2Lnw0uEyJBJgQ+OjxqgKvd9OKtsT8/s8Fd5vRuEDw0EeIBjCQ4iZPLAF3YHPniH2eUIy9pfSTutSfgc5rb7P29v9qFt+ZaQqZmBzg7a6yAgwMe41QGUEggwZo4eF+jfSllpv23OmZbB7Za9E5kkxeHnRXCLGbIS4ilWYfg2H0GGIRZYFxPmD3S3d1tpVJt7UFY4ACH4NWxKzNCFmYgXA8z3ooVZz760O5etcxOv3IwZQYwFM0c8Dd/XuBTL59cAgsbG3zKsgH1IuCIMkE5kK9GL1tz20LX16MIHHuqBCgoA1syJIE+K1e7H/YqwAd3/eTHSrVab8jpzCCQ45OrmjtywukBP7z8XK4Pynqzx15IgNrVy4JST5BQyudf9kNKkVd37xB3CgngJBLhC+qr5owfO7tcatu0YZ1BYjbp56VcAtqOnecO2S/LDqVOP48Ud5SFluYmr76uab4jsfqbY6kDxztkOrkE8Hm2etge2rw5454+bskCJEQE59bWVoPEbCWXwBsvPRcBDkB49usOUHABNx1dYX29fU792+XvHYn71693k5BvUVvieyCUEHyy+qe9tvaCDb0+5F16+3pdv9JfcW1Pe4+3DY8Om8XHwcSOD3xWTg4M2Lade2tHpfdOOqmDKAt+ZuRzq+zeF+c9cQYMMg4oVglc40zsWQ19CfLAU8ynzAF7sHim9P04thdJ0Y2KvyMAeG/PWldz0s7MBR69EJVIqzUG4RlzF9FKsMfjysZvbWj4rIslU73WZ0ALCvCsdK0YT8AAFDhOIjGtBzy8B3RWbLl5vPC7whMgHiTIxL3dK42soCN9BHACYHILJ2OegQ5wzo687bvjzus9CWIrvt8FUmj7qRRf3/OUO9X6T90+E7xGw47fuN+N9D4DSvFZx3aXFY51Lrmnf3zeHVTYybbfBao5RMiCTjeO1FzwoBSAk7WbFt3may/wrvZFYLmvK1qOamJjBzNVAhxQYlQAdMfLyexSiy5Tiiz4M81PGuB81vFD+PTfcGmdHT3xnl/kvgTOI35Qc+rFzDnPkUe/i8+CWDhgWo88kJQiyADEPMlp/x+2nHRgfKIh+jTLfhOmCGTBKQUCKODq03oycf/8xmN216ntqJ0ArhKuGVnlZq5PMxxCEr4EeeDamgJPwifg6gPe1bHUEZKfwFnIXGosviJxBASe5yQSsgmE4KS9Y8ktdu3qlD/7Q7sONF3vzDwrfhfUjAts9bSXrlu9BCgyePoTm6j+YeXFyb8i2dVqC2tnoYcELZNViy61BjBI2I6d5SXWWV5sCjg+UXXmJ/bt97db6IdRviG4Yua1hQRw1uFEv17A0A9fpJ5/4pE8/wNWTcdXfsfTiwAAAABJRU5ErkJggg==","class":"Manager","uuid":"manager","__CODE":"I.sprite = Sprite.NONE\n\nI.longestCombo = null\n\n20.times ->\n  engine.add 'Star'\n    x: rand(App.width)\n    y: rand(App.height)\n    radius: 1\n    color: 'rgba(255, 255, 255, 0.9)'\n    zIndex: -3\n    \n40.times ->\n  engine.add 'Star'\n    x: rand(App.width)\n    y: rand(App.height)\n    radius: 2\n    color: 'rgba(255, 255, 255, 0.9)'\n    zIndex: -2\n    \n5.times ->\n  engine.add 'Star'\n    x: rand(App.width)\n    y: rand(App.height)\n    radius: 4\n    color: 'rgba(255, 255, 255, 0.9)'    \n    zIndex: -1\n    \nself.on 'overlay', (canvas) ->\n  color = \"rgba(255, 255, 255, #{(1 - I.age / 2).clamp(0, 1)})\"\n  \n  if player = engine.first('Player')\n    canvas.font('15px Helvetica')\n    canvas.drawText\n      color: 'white'\n      x: 70\n      y: 70\n      text: \"Coins: \" + player.I.coins\n      \n  canvas.font('15px Helvetica')\n  canvas.drawText\n    color: 'white'\n    x: 20\n    y: 20\n    text: \"Target Score #{I.par}\"\n    \n  canvas.drawText\n    color: 'white'\n    x: 20\n    y: 40\n    text: \"Time Spent: \" + I.age.toFixed(0)  \n  \n  # hack to prevent flicker\n  if I.age < 1.95\n    canvas.font('30px Futura')\n    canvas.centerText\n      color: color\n      y: App.height / 2\n      text: engine.I.currentLevelName\n      \n  if I.longestCombo\n    canvas.font('20px Futura')\n    canvas.centerText\n      color: 'white'\n      y: 20\n      text: \"Longest Chain: \" + I.longestCombo\n   \nself.on \"update\", ->\n  if (player = engine.first('Player')) and not player?.I.bullets? \n    player.I.bullets = I.bullets\n      \n  hitPurples = 0\n  \n  purples = engine.find('PurpleEnemy')\n  \n  purples.each (purp) ->\n    if purp.I.alpha < 1\n      hitPurples += 1\n      \n  if purples.length is hitPurples\n    purples.invoke('destroy')\n    \n  if engine.find('.enemy').length is 0\n    engine.delay 0.5, ->\n      unless I.transitioning\n        I.transitioning = true\n        engine.nextLevel()\n        window.trackLevel(App.title, 'complete', engine.I.currentLevelName, I.age * 1000)\n","par":2,"bullets":5,"offsetX":0,"offsetY":0,"transitioning":false},"player":{"name":"Unnamed Entity","width":16,"height":16,"class":"Player","uuid":"player","__CODE":"I.velocity = Point(0, 0)\nI.facing = Point(1, 0)\n\nmine0 = Sprite.loadByName 'mine0'\nmine1 = Sprite.loadByName 'mine1'\nmine2 = Sprite.loadByName 'mine2'\nmine3 = Sprite.loadByName 'mine3'\nmine4 = Sprite.loadByName 'mine4'\n\nI.mineIndex = 0\n\nI.coins = 0\n\nI.mineSprites = [mine0, mine1, mine2, mine3, mine4, mine3, mine2, mine1]\nI.mineSprite = mine0\n\nself.every 0.075, ->\n  I.mineIndex = (I.mineIndex + 1) % I.mineSprites.length\n  I.mineSprite = I.mineSprites[I.mineIndex]\n\narrow = Sprite.loadByName 'arrow'\n\nI.directions =\n  up: Point.UP\n  down: Point.DOWN\n  left: Point.LEFT\n  right: Point.RIGHT\n  \nif I.looking\n  I.facing = I.directions[I.looking]\n\nself.clampToBounds()\n\nself.extend\n  handleMovement: ->    \n    I.velocity.x = 0\n    I.velocity.y = 0\n   \n    unless I.immobile\n      if I.facing.x.abs()\n        if keydown.up\n          I.velocity.x = 0\n          I.velocity.y = -1      \n        \n        if keydown.down\n          I.velocity.x = 0\n          I.velocity.y = 1     \n          \n      if I.facing.y.abs()\n        if keydown.left\n          I.velocity.x = -1\n          I.velocity.y = 0      \n        \n        if keydown.right\n          I.velocity.x = 1\n          I.velocity.y = 0   \n          \n      if I.velocity.x.abs() > 0\n        self.tween 0.1\n          scaleY: 0.7\n          scaleX: 1.3\n\n      if I.velocity.y.abs() > 0\n        self.tween 0.1\n          scaleX: 0.7\n          scaleY: 1.3\n          \n      if I.velocity.magnitude() is 0\n        self.tween 0.1\n          scaleX: 1\n          scaleY: 1            \n        \n    I.velocity = I.velocity.scale$(I.speed)\n    \n  shoot: ->\n    engine.shake()\n    I.bullets = I.bullets.approach(0, 1)\n    \n    direction = mousePosition.subtract(self.position()).norm()\n    \n    engine.add\n      class: \"Bullet\"\n      x: I.x + (direction.x * 30)\n      y: I.y + (direction.y * 30)\n      velocity: direction.scale(I.bulletSpeed)   \n\nself.on 'create', -> \n  I.x += 8\n  I.y += 8\n      \nself.on 'destroy', ->\n  engine.delay 1, ->\n    engine.reloadLevel()\n      \nself.on 'overlay', (canvas) ->\n  canvas.drawLine\n    color: Color('#FF7700', 0.5)\n    start: self.position()\n    end: mousePosition  \n      \n  if I.bullets <= 0 and not engine.find('Bullet').length \n    if engine.find('.enemy').length > 0\n      canvas.font '30px Futura' \n      canvas.centerText\n        color: 'white'\n        y: 200\n        text: 'Press \"r\" to restart'\n      \nself.on 'draw', (canvas) ->\n  direction = mousePosition.subtract(self.position())\n  \n  angle = Math.atan2(direction.y, direction.x)\n  \n  canvas.withTransform Matrix.rotate(angle), ->\n    x = self.position().x\n    \n    mouseX = mousePosition.x\n   \n    if mouseX > x \n      arrow.draw(canvas, mouseX - x, -arrow.height/2)  \n    else\n      arrow.draw(canvas, x - mouseX, -arrow.height/2) \n  \n  if I.bullets\n    I.mineSprites[I.mineIndex].draw(canvas, -16, -16)\n  \n  I.bullets.times (n) ->\n    canvas.drawCircle\n      color: 'white'\n      x: 5 * n - 5\n      y: -10\n      radius: 2\n            \nself.on \"update\", ->  \n  if mousePressed.left and I.bullets\n    self.shoot()\n      \n  Collision.collide self, '.enemy', (pl, enemy) ->\n    pl.destroy()\n    \n  Collision.collide self, 'Bullet', (pl, bullet) ->\n    return unless bullet.I.age > 0.5\n    \n    return if bullet.I.stuckTo\n    bullet.destroy()\n    pl.destroy()\n  \n  if (bullets = engine.find('Bullet')).length\n    if justPressed.space\n      I.detonations += 1\n      bullets.invoke('explode')\n     \n  self.handleMovement()\n","speed":120,"bullets":null,"immobile":true,"detonations":0,"bulletSpeed":240,"sprite":"player"},"portal_enemy":{"name":"Unnamed Entity","width":32,"height":32,"class":"PortalEnemy","parentClass":"Enemy","__CODE":"I.directions = []\nI.rotationalVelocity = -Math.TAU / 4\n\nself.on 'destroy', ->\n  match = self.findMatch()\n                \n  if match\n    {x, y} = match.I\n    \n    I.bullet.moveTo(x, y)\n\n    match.I.skipCollide = 2\n\nself.on 'update', (dt) ->\n  I.skipCollide = I.skipCollide.approach(0, 1)\n  \n  Collision.collide self, 'Bullet', (portal, bullet) ->\n    return if portal.I.skipCollide\n    \n    I.bullet = bullet\n    portal.destroy()\n    \nself.extend\n  findMatch: ->\n    match = null\n    \n    engine.each 'PortalEnemy', (portal) ->\n      return if portal is self\n      \n      match = portal if portal.I.portalLink is I.portalLink\n    \n    return match\n    ","uuid":"portal_enemy","bullet":null,"portalLink":"1","sprite":"portal","skipCollide":0,"rotation":0},"purple_enemy":{"name":"Unnamed Entity","width":32,"height":32,"class":"PurpleEnemy","uuid":"purple_enemy","__CODE":"self.bind 'update', ->\n  I.alpha = I.alpha.approach(1, 0.005)\n    ","alpha":1,"parentClass":"Enemy","sprite":"time"},"red_enemy":{"name":"Unnamed Entity","width":32,"height":32,"uuid":"red_enemy","class":"RedEnemy","__CODE":"I.directions = [\n  Point(0, -20)\n  Point(0, 20)\n]","parentClass":"Enemy","lineColor":"red","sprite":"vertical"},"reflect_enemy":{"name":"Unnamed Entity","width":32,"height":32,"class":"ReflectEnemy","parentClass":"Enemy","__CODE":"self.extend\n  boundingLines: ->    \n    halfWidth = I.width / 2\n    halfHeight = I.height / 2\n    \n    topLeft = Point(I.x - halfWidth, I.y - halfHeight)\n    topRight = Point(I.x + halfWidth, I.y - halfHeight)\n    bottomLeft = Point(I.x - halfWidth, I.y + halfHeight)\n    bottomRight = Point(I.x + halfWidth, I.y + halfHeight)\n        \n    top = Line\n      start: topLeft\n      end: topRight\n      \n    left = Line\n      start: topLeft\n      end: bottomLeft\n      \n    right = Line\n      start: topRight\n      end: bottomRight\n      \n    bottom = Line\n      start: bottomLeft\n      end: bottomRight\n    \n    [top, right, bottom, left]    ","uuid":"reflect_enemy","sprite":"rubber"},"shotgun_enemy":{"name":"Unnamed Entity","width":32,"height":32,"class":"ShotgunEnemy","parentClass":"Enemy","__CODE":"I.directions = [\n  Point(-20, -20)\n  Point(0, -20)\n  Point(20, 20)\n  Point(20, 0)\n  Point(20, -20)\n  Point(0, 20)\n  Point(-20, 20)\n  Point(-20, 0)\n]","uuid":"shotgun_enemy","lineColor":"pink","sprite":"shotgun"},"star":{"name":"Unnamed Entity","width":32,"height":32,"class":"Star","parentClass":"GameObject","__CODE":"self.cooldown 'blinkCooldown'\n\nself.on 'update', ->\n  if rand() < 0.001 and not I.blinkCooldown\n    I.blinkCooldown = 0.5\n    I.alpha = 0\n  else if not I.blinkCooldown\n    I.alpha = 1\n","uuid":"star","blinkCooldown":0},"target_enemy":{"name":"Unnamed Entity","width":32,"height":32,"class":"TargetEnemy","parentClass":"Enemy","__CODE":"turret = Sprite.loadByName 'turret'\n\nself.on 'draw', (canvas) ->\n  if player = engine.first('Player')\n    direction = player.position().subtract(self.position()).norm()\n    \n    angle = Math.atan2(direction.y, direction.x)\n    \n    canvas.withTransform Matrix.rotation(angle), ->\n      turret.draw(canvas, -I.width / 4, -I.height / 2)\n\nself.on 'update', ->\n  if player = engine.first('Player')\n    I.directions = [player.position().subtract(self.position()).norm().scale(20)]","uuid":"target_enemy","sprite":"tank","bulletSpeed":450,"lineColor":"#CE6FB2"},"yellow_enemy":{"name":"Unnamed Entity","width":32,"height":32,"uuid":"yellow_enemy","class":"YellowEnemy","__CODE":"I.directions = [\n  Point(-20, -20)\n  Point(20, 20)\n  Point(20, -20)\n  Point(-20, 20)\n]","parentClass":"Enemy","originalAlpha":1,"lineColor":"yellow","sprite":"diagonal"}},"layers":[{"name":"Background","instances":[{"uuid":"manager","x":0,"y":0,"properties":{"par":1,"bullets":1}},{"uuid":"player","x":32,"y":224,"properties":{}}]},{"name":"Entities","instances":[{"uuid":"boomerang_enemy","x":160,"y":448,"properties":{}},{"uuid":"boomerang_enemy","x":256,"y":384,"properties":{}},{"uuid":"boomerang_enemy","x":352,"y":320,"properties":{}},{"uuid":"boomerang_enemy","x":448,"y":256,"properties":{}},{"uuid":"boomerang_enemy","x":544,"y":192,"properties":{}},{"uuid":"absorb_enemy","x":192,"y":0,"properties":{"moving":true,"verticalPath":true,"behaviors":"verticalPath"}}]}],"orientation":"orthogonal"},"entityList":{"absorb_enemy":{"name":"Unnamed Entity","width":32,"height":32,"class":"AbsorbEnemy","parentClass":"Enemy","__CODE":"jelly0 = Sprite.loadByName 'jelly0'\njelly1 = Sprite.loadByName 'jelly1'\njelly2 = Sprite.loadByName 'jelly2'\n\nI.sprites = [jelly1, jelly0, jelly2, jelly0]\n\nself.every 0.2, ->\n  I.spriteIndex = (I.spriteIndex + 1) % I.sprites.length\n\nself.on 'update', ->  \n  I.sprite = I.sprites[I.spriteIndex]\n  ","uuid":"absorb_enemy","spriteIndex":0,"sprite":"jelly0"},"boomerang_enemy":{"name":"Unnamed Entity","width":32,"height":32,"class":"BoomerangEnemy","parentClass":"Enemy","__CODE":"I.directions = [Point(20, -10)]","uuid":"boomerang_enemy","sprite":"boomerang_enemy","boomerang":true,"lineColor":"orange"},"bullet":{"name":"Unnamed Entity","width":12,"height":12,"class":"Bullet","parentClass":"GameObject","speed":240,"stuckTo":null,"zIndex":50,"__CODE":"I.color = 'transparent'\n\nmine0 = Sprite.loadByName 'mine0'\nmine1 = Sprite.loadByName 'mine1'\nmine2 = Sprite.loadByName 'mine2'\nmine3 = Sprite.loadByName 'mine3'\nmine4 = Sprite.loadByName 'mine4'\n\nI.particleIndex = 0\n\nI.rotationalVelocities = [\n  Math.TAU / 32\n  Math.TAU / 48\n  Math.TAU / 64\n]\n\nI.rotationalVelocity = I.rotationalVelocities.rand()\n\nI.sprites = [mine0, mine1, mine2, mine3, mine4, mine3, mine2, mine1]\n\nself.every 0.075, ->\n  I.spriteIndex = (I.spriteIndex + 1) % I.sprites.length\n  \nself.extend\n  collisions: (dt) ->\n    Collision.collide self, '.collectable', (bullet, item) ->\n      item.destroy()    \n    \n    Collision.collide self, '.enemy', (bullet, enemy) ->\n      return if enemy.I.class is 'ReflectEnemy'\n      return if enemy.I.class is 'PortalEnemy'\n      \n      if not I.stuckTo and enemy.I.alpha is 1\n        if enemy.I.class is 'ReflectEnemy'          \n          enemy.I.destroyedBy = self\n          \n          enemyRect = Rectangle(enemy.bounds())\n          \n          # TODO step through x and y velocity one pixel at a time\n          if (leftSide = bullet.I.x < enemyRect.left) or (rightSide = bullet.I.x > enemyRect.right)\n            direction = bullet.I.velocity\n            direction.x = -direction.x  \n          else if (topSide = bullet.I.y < enemyRect.top) or (bottomSide = bullet.I.y > enemyRect.bottom)\n            direction = bullet.I.velocity\n            direction.y = -direction.y\n\n          bullet.I.combo += 1\n        else\n          I.stuckTo = enemy\n          enemy.I.stuckTo = self\n          I.velocity.x = 0\n          I.velocity.y = 0\n  explode: ->    \n    if I.stuckTo\n      if I.stuckTo.I.class is 'PurpleEnemy'\n        I.stuckTo.I.alpha = 0.2\n        I.stuckTo.I.destroyedBy = self\n      else\n        I.stuckTo.I.destroyedBy = self\n        I.stuckTo.destroy()\n        \n    self.destroy()\n  moveTo: (x, y) ->\n    I.x = x\n    I.y = y\n  reflectCollisions: (dt) ->\n    position = self.position()\n    \n    vLine = Line\n      start: position\n      end: position.add(I.velocity.scale(dt))\n  \n    engine.each \"ReflectEnemy\", (enemy) -> \n      return if enemy.I.alpha < 1\n    \n      hit = false\n  \n      enemy.boundingLines().each (line) ->  \n        if line.intersects(vLine)\n          normal = line.normal()\n          push = normal.scale(-2 * I.velocity.dot(normal))\n          \n          I.velocity = I.velocity.add(push)\n          \n          I.x += I.velocity.x * dt\n          I.y += I.velocity.y * dt\n          \n          hit = true \n          \n      if hit\n        enemy.I.destroyedBy = self\n        enemy.tween 0.075, \n          scaleX: 1.2\n          scaleY: 0.8\n          easing: \"quadratic\"\n          complete: ->\n            enemy.tween 0.075, \n              scaleX: 0.8\n              scaleY: 1.2\n              easing: \"quadratic\"\n              complete: ->\n                enemy.tween 0.075, \n                  scaleX: 1.2\n                  scaleY: 0.8\n                  easing: \"quadratic\"\n                  complete: ->\n                    enemy.destroy()  \n               \nself.on 'update', (dt) ->\n  if I.velocity.magnitude() > 0\n    I.particleIndex += 1\n    \n    if I.particleIndex % 5 is 0  \n      engine.add\n        duration: 1\n        fadeOut: true\n        x: I.x\n        y: I.y\n        radius: [1, 2, 2].rand()\n        velocity: Point.fromAngle(I.rotation).scale([50, 10].rand())\n        color: Color('red', 0.6)\n  else  \n    I.rotation = 0\n    \n  I.rotation += I.rotationalVelocity\n  \n  I.sprite = I.sprites[I.spriteIndex]  \n  \n  if I.boomerang\n    I.velocity.x = I.velocity.x.approach(-I.speed * 2, 6)\n    I.velocity.y = I.velocity.y.approach(0, 0.5)\n   \n  self.reflectCollisions(dt)\n  self.collisions(dt)\n      \n  if I.stuckTo\n    {x, y} = I.stuckTo.I\n    \n    self.moveTo(x, y)\n    \n  self.destroy() unless -I.activeBuffer <= I.x <= I.activeBuffer + App.width\n  self.destroy() unless -I.activeBuffer <= I.y <= I.activeBuffer + App.height\n","uuid":"bullet","combo":0,"scaleX":1,"scaleY":1,"tweeningToZero":false,"radius":6,"activeBuffer":80,"spriteIndex":0,"sprite":"mine0"},"coin":{"name":"Unnamed Entity","width":32,"height":32,"class":"Coin","parentClass":"GameObject","__CODE":"I.sprite = Sprite.loadByName 'coin'\nI.collectable = true\n\nself.on 'destroy', ->\n  if player = engine.first('Player')\n    player.I.coins += 1","uuid":"coin","sprite":"coin"},"GreenEnemy":{"name":"Unnamed Entity","width":32,"height":32,"class":"GreenEnemy","uuid":"GreenEnemy","__CODE":"I.directions = [\n  Point(-20, 0)\n  Point(20, 0)\n]  ","parentClass":"Enemy","speed":0.25,"oscillate":true,"sprite":"horizontal"},"manager":{"name":"Unnamed Entity","width":32,"height":32,"sprite":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAEzElEQVRYCbWXXYhVVRTH153EbKaZ0RjKRKdrM9NDfqCNFGbJpA8NmBQoJhOEbxH6ECR4lR7DxvLBh8KHXiwoNSiycWAqtIlKERqD0AL7oKYwqalp5tZUEp7Ob5/577vPmXMu89KCe/bea62z/v+91v44txRFkd3x6u+RxbK0pcHefaSlRP//lAffnnR4YMwRUGXNDdY2r2Qy5hE5UDrgX9R7Ybsn2lOXvGLvXDnPvbb74ylroHfp8fml/k//srG/I8PIT84CALy9p90Ni9p6BImn2OAADq7PAJGvTF2Lnw0uEyJBJgQ+OjxqgKvd9OKtsT8/s8Fd5vRuEDw0EeIBjCQ4iZPLAF3YHPniH2eUIy9pfSTutSfgc5rb7P29v9qFt+ZaQqZmBzg7a6yAgwMe41QGUEggwZo4eF+jfSllpv23OmZbB7Za9E5kkxeHnRXCLGbIS4ilWYfg2H0GGIRZYFxPmD3S3d1tpVJt7UFY4ACH4NWxKzNCFmYgXA8z3ooVZz760O5etcxOv3IwZQYwFM0c8Dd/XuBTL59cAgsbG3zKsgH1IuCIMkE5kK9GL1tz20LX16MIHHuqBCgoA1syJIE+K1e7H/YqwAd3/eTHSrVab8jpzCCQ45OrmjtywukBP7z8XK4Pynqzx15IgNrVy4JST5BQyudf9kNKkVd37xB3CgngJBLhC+qr5owfO7tcatu0YZ1BYjbp56VcAtqOnecO2S/LDqVOP48Ud5SFluYmr76uab4jsfqbY6kDxztkOrkE8Hm2etge2rw5454+bskCJEQE59bWVoPEbCWXwBsvPRcBDkB49usOUHABNx1dYX29fU792+XvHYn71693k5BvUVvieyCUEHyy+qe9tvaCDb0+5F16+3pdv9JfcW1Pe4+3DY8Om8XHwcSOD3xWTg4M2Lade2tHpfdOOqmDKAt+ZuRzq+zeF+c9cQYMMg4oVglc40zsWQ19CfLAU8ynzAF7sHim9P04thdJ0Y2KvyMAeG/PWldz0s7MBR69EJVIqzUG4RlzF9FKsMfjysZvbWj4rIslU73WZ0ALCvCsdK0YT8AAFDhOIjGtBzy8B3RWbLl5vPC7whMgHiTIxL3dK42soCN9BHACYHILJ2OegQ5wzo687bvjzus9CWIrvt8FUmj7qRRf3/OUO9X6T90+E7xGw47fuN+N9D4DSvFZx3aXFY51Lrmnf3zeHVTYybbfBao5RMiCTjeO1FzwoBSAk7WbFt3may/wrvZFYLmvK1qOamJjBzNVAhxQYlQAdMfLyexSiy5Tiiz4M81PGuB81vFD+PTfcGmdHT3xnl/kvgTOI35Qc+rFzDnPkUe/i8+CWDhgWo88kJQiyADEPMlp/x+2nHRgfKIh+jTLfhOmCGTBKQUCKODq03oycf/8xmN216ntqJ0ArhKuGVnlZq5PMxxCEr4EeeDamgJPwifg6gPe1bHUEZKfwFnIXGosviJxBASe5yQSsgmE4KS9Y8ktdu3qlD/7Q7sONF3vzDwrfhfUjAts9bSXrlu9BCgyePoTm6j+YeXFyb8i2dVqC2tnoYcELZNViy61BjBI2I6d5SXWWV5sCjg+UXXmJ/bt97db6IdRviG4Yua1hQRw1uFEv17A0A9fpJ5/4pE8/wNWTcdXfsfTiwAAAABJRU5ErkJggg==","class":"Manager","uuid":"manager","__CODE":"I.sprite = Sprite.NONE\n\nI.longestCombo = null\n\n20.times ->\n  engine.add 'Star'\n    x: rand(App.width)\n    y: rand(App.height)\n    radius: 1\n    color: 'rgba(255, 255, 255, 0.9)'\n    zIndex: -3\n    \n40.times ->\n  engine.add 'Star'\n    x: rand(App.width)\n    y: rand(App.height)\n    radius: 2\n    color: 'rgba(255, 255, 255, 0.9)'\n    zIndex: -2\n    \n5.times ->\n  engine.add 'Star'\n    x: rand(App.width)\n    y: rand(App.height)\n    radius: 4\n    color: 'rgba(255, 255, 255, 0.9)'    \n    zIndex: -1\n    \nself.on 'overlay', (canvas) ->\n  color = \"rgba(255, 255, 255, #{(1 - I.age / 2).clamp(0, 1)})\"\n  \n  if player = engine.first('Player')\n    canvas.font('15px Helvetica')\n    canvas.drawText\n      color: 'white'\n      x: 70\n      y: 70\n      text: \"Coins: \" + player.I.coins\n      \n  canvas.font('15px Helvetica')\n  canvas.drawText\n    color: 'white'\n    x: 20\n    y: 20\n    text: \"Target Score #{I.par}\"\n    \n  canvas.drawText\n    color: 'white'\n    x: 20\n    y: 40\n    text: \"Time Spent: \" + I.age.toFixed(0)  \n  \n  # hack to prevent flicker\n  if I.age < 1.95\n    canvas.font('30px Futura')\n    canvas.centerText\n      color: color\n      y: App.height / 2\n      text: engine.I.currentLevelName\n      \n  if I.longestCombo\n    canvas.font('20px Futura')\n    canvas.centerText\n      color: 'white'\n      y: 20\n      text: \"Longest Chain: \" + I.longestCombo\n   \nself.on \"update\", ->\n  if (player = engine.first('Player')) and not player?.I.bullets? \n    player.I.bullets = I.bullets\n      \n  hitPurples = 0\n  \n  purples = engine.find('PurpleEnemy')\n  \n  purples.each (purp) ->\n    if purp.I.alpha < 1\n      hitPurples += 1\n      \n  if purples.length is hitPurples\n    purples.invoke('destroy')\n    \n  if engine.find('.enemy').length is 0\n    engine.delay 0.5, ->\n      unless I.transitioning\n        I.transitioning = true\n        engine.nextLevel()\n        window.trackLevel(App.title, 'complete', engine.I.currentLevelName, I.age * 1000)\n","par":2,"bullets":5,"offsetX":0,"offsetY":0,"transitioning":false},"player":{"name":"Unnamed Entity","width":16,"height":16,"class":"Player","uuid":"player","__CODE":"I.velocity = Point(0, 0)\nI.facing = Point(1, 0)\n\nmine0 = Sprite.loadByName 'mine0'\nmine1 = Sprite.loadByName 'mine1'\nmine2 = Sprite.loadByName 'mine2'\nmine3 = Sprite.loadByName 'mine3'\nmine4 = Sprite.loadByName 'mine4'\n\nI.mineIndex = 0\n\nI.coins = 0\n\nI.mineSprites = [mine0, mine1, mine2, mine3, mine4, mine3, mine2, mine1]\nI.mineSprite = mine0\n\nself.every 0.075, ->\n  I.mineIndex = (I.mineIndex + 1) % I.mineSprites.length\n  I.mineSprite = I.mineSprites[I.mineIndex]\n\narrow = Sprite.loadByName 'arrow'\n\nI.directions =\n  up: Point.UP\n  down: Point.DOWN\n  left: Point.LEFT\n  right: Point.RIGHT\n  \nif I.looking\n  I.facing = I.directions[I.looking]\n\nself.clampToBounds()\n\nself.extend\n  handleMovement: ->    \n    I.velocity.x = 0\n    I.velocity.y = 0\n   \n    unless I.immobile\n      if I.facing.x.abs()\n        if keydown.up\n          I.velocity.x = 0\n          I.velocity.y = -1      \n        \n        if keydown.down\n          I.velocity.x = 0\n          I.velocity.y = 1     \n          \n      if I.facing.y.abs()\n        if keydown.left\n          I.velocity.x = -1\n          I.velocity.y = 0      \n        \n        if keydown.right\n          I.velocity.x = 1\n          I.velocity.y = 0   \n          \n      if I.velocity.x.abs() > 0\n        self.tween 0.1\n          scaleY: 0.7\n          scaleX: 1.3\n\n      if I.velocity.y.abs() > 0\n        self.tween 0.1\n          scaleX: 0.7\n          scaleY: 1.3\n          \n      if I.velocity.magnitude() is 0\n        self.tween 0.1\n          scaleX: 1\n          scaleY: 1            \n        \n    I.velocity = I.velocity.scale$(I.speed)\n    \n  shoot: ->\n    engine.shake()\n    I.bullets = I.bullets.approach(0, 1)\n    \n    direction = mousePosition.subtract(self.position()).norm()\n    \n    engine.add\n      class: \"Bullet\"\n      x: I.x + (direction.x * 30)\n      y: I.y + (direction.y * 30)\n      velocity: direction.scale(I.bulletSpeed)   \n\nself.on 'create', -> \n  I.x += 8\n  I.y += 8\n      \nself.on 'destroy', ->\n  engine.delay 1, ->\n    engine.reloadLevel()\n      \nself.on 'overlay', (canvas) ->\n  canvas.drawLine\n    color: Color('#FF7700', 0.5)\n    start: self.position()\n    end: mousePosition  \n      \n  if I.bullets <= 0 and not engine.find('Bullet').length \n    if engine.find('.enemy').length > 0\n      canvas.font '30px Futura' \n      canvas.centerText\n        color: 'white'\n        y: 200\n        text: 'Press \"r\" to restart'\n      \nself.on 'draw', (canvas) ->\n  direction = mousePosition.subtract(self.position())\n  \n  angle = Math.atan2(direction.y, direction.x)\n  \n  canvas.withTransform Matrix.rotate(angle), ->\n    x = self.position().x\n    \n    mouseX = mousePosition.x\n   \n    if mouseX > x \n      arrow.draw(canvas, mouseX - x, -arrow.height/2)  \n    else\n      arrow.draw(canvas, x - mouseX, -arrow.height/2) \n  \n  if I.bullets\n    I.mineSprites[I.mineIndex].draw(canvas, -16, -16)\n  \n  I.bullets.times (n) ->\n    canvas.drawCircle\n      color: 'white'\n      x: 5 * n - 5\n      y: -10\n      radius: 2\n            \nself.on \"update\", ->  \n  if mousePressed.left and I.bullets\n    self.shoot()\n      \n  Collision.collide self, '.enemy', (pl, enemy) ->\n    pl.destroy()\n    \n  Collision.collide self, 'Bullet', (pl, bullet) ->\n    return unless bullet.I.age > 0.5\n    \n    return if bullet.I.stuckTo\n    bullet.destroy()\n    pl.destroy()\n  \n  if (bullets = engine.find('Bullet')).length\n    if justPressed.space\n      I.detonations += 1\n      bullets.invoke('explode')\n     \n  self.handleMovement()\n","speed":120,"bullets":null,"immobile":true,"detonations":0,"bulletSpeed":240,"sprite":"player"},"portal_enemy":{"name":"Unnamed Entity","width":32,"height":32,"class":"PortalEnemy","parentClass":"Enemy","__CODE":"I.directions = []\nI.rotationalVelocity = -Math.TAU / 4\n\nself.on 'destroy', ->\n  match = self.findMatch()\n                \n  if match\n    {x, y} = match.I\n    \n    I.bullet.moveTo(x, y)\n\n    match.I.skipCollide = 2\n\nself.on 'update', (dt) ->\n  I.skipCollide = I.skipCollide.approach(0, 1)\n  \n  Collision.collide self, 'Bullet', (portal, bullet) ->\n    return if portal.I.skipCollide\n    \n    I.bullet = bullet\n    portal.destroy()\n    \nself.extend\n  findMatch: ->\n    match = null\n    \n    engine.each 'PortalEnemy', (portal) ->\n      return if portal is self\n      \n      match = portal if portal.I.portalLink is I.portalLink\n    \n    return match\n    ","uuid":"portal_enemy","bullet":null,"portalLink":"1","sprite":"portal","skipCollide":0,"rotation":0},"purple_enemy":{"name":"Unnamed Entity","width":32,"height":32,"class":"PurpleEnemy","uuid":"purple_enemy","__CODE":"self.bind 'update', ->\n  I.alpha = I.alpha.approach(1, 0.005)\n    ","alpha":1,"parentClass":"Enemy","sprite":"time"},"red_enemy":{"name":"Unnamed Entity","width":32,"height":32,"uuid":"red_enemy","class":"RedEnemy","__CODE":"I.directions = [\n  Point(0, -20)\n  Point(0, 20)\n]","parentClass":"Enemy","lineColor":"red","sprite":"vertical"},"reflect_enemy":{"name":"Unnamed Entity","width":32,"height":32,"class":"ReflectEnemy","parentClass":"Enemy","__CODE":"self.extend\n  boundingLines: ->    \n    halfWidth = I.width / 2\n    halfHeight = I.height / 2\n    \n    topLeft = Point(I.x - halfWidth, I.y - halfHeight)\n    topRight = Point(I.x + halfWidth, I.y - halfHeight)\n    bottomLeft = Point(I.x - halfWidth, I.y + halfHeight)\n    bottomRight = Point(I.x + halfWidth, I.y + halfHeight)\n        \n    top = Line\n      start: topLeft\n      end: topRight\n      \n    left = Line\n      start: topLeft\n      end: bottomLeft\n      \n    right = Line\n      start: topRight\n      end: bottomRight\n      \n    bottom = Line\n      start: bottomLeft\n      end: bottomRight\n    \n    [top, right, bottom, left]    ","uuid":"reflect_enemy","sprite":"rubber"},"shotgun_enemy":{"name":"Unnamed Entity","width":32,"height":32,"class":"ShotgunEnemy","parentClass":"Enemy","__CODE":"I.directions = [\n  Point(-20, -20)\n  Point(0, -20)\n  Point(20, 20)\n  Point(20, 0)\n  Point(20, -20)\n  Point(0, 20)\n  Point(-20, 20)\n  Point(-20, 0)\n]","uuid":"shotgun_enemy","lineColor":"pink","sprite":"shotgun"},"star":{"name":"Unnamed Entity","width":32,"height":32,"class":"Star","parentClass":"GameObject","__CODE":"self.cooldown 'blinkCooldown'\n\nself.on 'update', ->\n  if rand() < 0.001 and not I.blinkCooldown\n    I.blinkCooldown = 0.5\n    I.alpha = 0\n  else if not I.blinkCooldown\n    I.alpha = 1\n","uuid":"star","blinkCooldown":0},"target_enemy":{"name":"Unnamed Entity","width":32,"height":32,"class":"TargetEnemy","parentClass":"Enemy","__CODE":"turret = Sprite.loadByName 'turret'\n\nself.on 'draw', (canvas) ->\n  if player = engine.first('Player')\n    direction = player.position().subtract(self.position()).norm()\n    \n    angle = Math.atan2(direction.y, direction.x)\n    \n    canvas.withTransform Matrix.rotation(angle), ->\n      turret.draw(canvas, -I.width / 4, -I.height / 2)\n\nself.on 'update', ->\n  if player = engine.first('Player')\n    I.directions = [player.position().subtract(self.position()).norm().scale(20)]","uuid":"target_enemy","sprite":"tank","bulletSpeed":450,"lineColor":"#CE6FB2"},"yellow_enemy":{"name":"Unnamed Entity","width":32,"height":32,"uuid":"yellow_enemy","class":"YellowEnemy","__CODE":"I.directions = [\n  Point(-20, -20)\n  Point(20, 20)\n  Point(20, -20)\n  Point(-20, 20)\n]","parentClass":"Enemy","originalAlpha":1,"lineColor":"yellow","sprite":"diagonal"}}}
